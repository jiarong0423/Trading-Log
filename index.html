<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº¤æ˜“æ—¥èªŒç›£æ§è¡¨</title>
  <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
      .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 30px; }
      h1 { text-align: center; color: #667eea; margin-bottom: 30px; font-size: 2.5em; }
      .form-section { background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px; }
      .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
      .form-group { display: flex; flex-direction: column; }
      label { font-weight: bold; margin-bottom: 8px; color: #333; font-size: 14px; }
      input, select, textarea { padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; background: white; }
      input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
      textarea { resize: vertical; min-height: 80px; }
      .positions-section { background: #fff; border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
      .positions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
      .position-item { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: center; position: relative; }
      .position-item.long { border-left-color: #28a745; background: #f0f9f4; }
      .position-item.short { border-left-color: #dc3545; background: #fef5f5; }
      .position-item.futures { border-left-width: 6px; }
      .position-field { display: flex; flex-direction: column; }
      .position-field label { font-size: 12px; color: #666; margin-bottom: 5px; }
      .position-field input, .position-field select { padding: 8px; font-size: 13px; }
      .position-field input.current-price-field { border: 2px solid #ff9800; background: #fff9e6; }
      .position-pnl { grid-column: 1 / -1; text-align: center; font-size: 18px; font-weight: bold; padding: 12px; background: white; border-radius: 5px; margin-top: 5px; border: 2px solid #ddd; }
      .remove-position-btn { position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 16px; line-height: 1; }
      .remove-position-btn:hover { background: #c82333; }
      .button-group { display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
      button { padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
      .btn-primary { background: #667eea; color: white; }
      .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
      .btn-success { background: #28a745; color: white; }
      .btn-success:hover { background: #218838; transform: translateY(-2px); }
      .btn-secondary { background: #6c757d; color: white; }
      .btn-secondary:hover { background: #5a6268; transform: translateY(-2px); }
      .btn-danger { background: #dc3545; color: white; }
      .btn-danger:hover { background: #c82333; }
      .btn-add { background: #17a2b8; color: white; padding: 8px 20px; font-size: 14px; }
      .btn-add:hover { background: #138496; }
      .btn-info { background: #17a2b8; color: white; }
      .btn-info:hover { background: #138496; transform: translateY(-2px); }
      .btn-warning { background: #ffc107; color: #333; }
      .btn-warning:hover { background: #e0a800; transform: translateY(-2px); }
      table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
      th { background: #667eea; color: white; padding: 15px; text-align: left; font-weight: bold; font-size: 14px; }
      td { padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 13px; }
      tr:hover { background: #f8f9fa; }
      tr.open-position { background: #fff9e6; }
      .profit { color: #28a745; font-weight: bold; }
      .loss { color: #dc3545; font-weight: bold; }
      .unrealized { color: #ff9800; font-weight: bold; }
      .correct { color: #28a745; }
      .incorrect { color: #dc3545; }
      .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
      .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
      .stat-card.unrealized-card { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); }
      .stat-card.profit-card { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
      .stat-card.loss-card { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
      .stat-card h3 { font-size: 14px; margin-bottom: 10px; opacity: 0.9; }
      .stat-card .value { font-size: 24px; font-weight: bold; }
      .delete-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
      .delete-btn:hover { background: #c82333; }
      .close-btn { background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-right: 5px; }
      .close-btn:hover { background: #218838; }
      .update-price-btn { background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-right: 5px; }
      .update-price-btn:hover { background: #f57c00; }
      .edit-btn { background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-right: 5px; }
      .edit-btn:hover { background: #138496; }
      .hidden { display: none !important; }
      .settlement-section { background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px; }
      .settlement-controls { display: flex; gap: 15px; align-items: end; margin-bottom: 20px; flex-wrap: wrap; }
      .settlement-summary { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
      .settlement-summary.negative { background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); }
      .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
      .summary-item { text-align: center; }
      .summary-item .label { font-size: 12px; opacity: 0.9; margin-bottom: 5px; }
      .summary-item .value { font-size: 24px; font-weight: bold; }
      .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
      .badge-open { background: #ffc107; color: #333; }
      .badge-closed { background: #6c757d; color: white; }
      .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
      .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 700px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
      .close-modal { font-size: 28px; font-weight: bold; color: #999; cursor: pointer; }
      .close-modal:hover { color: #333; }
      .current-price-input { border: 2px solid #ff9800 !important; background: #fff9e6 !important; }
      .price-update-section { background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
      .price-update-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; align-items: center; padding: 10px; background: white; border-radius: 5px; margin-bottom: 10px; }
      .price-update-row label { font-size: 13px; font-weight: bold; }
      .total-unrealized { font-size: 24px; font-weight: bold; text-align: center; padding: 15px; border-radius: 8px; margin-top: 15px; }
      .total-unrealized.profit { background: #d4edda; color: #28a745; }
      .total-unrealized.loss { background: #f8d7da; color: #dc3545; }
      @media (max-width: 768px) { .position-item { grid-template-columns: 1fr; } .button-group { flex-direction: column; } button { width: 100%; } .settlement-controls { flex-direction: column; align-items: stretch; } .price-update-row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
      <h1>ğŸ“Š äº¤æ˜“æ—¥èªŒç³»çµ±</h1>
      
      <div class="form-section">
          <h2 style="margin-bottom: 20px; color: #667eea;">æ–°å¢äº¤æ˜“è¨˜éŒ„</h2>
          <form id="tradeForm">
              <div class="form-grid">
                  <div class="form-group">
                      <label for="date">äº¤æ˜“æ—¥æœŸ *</label>
                      <input type="date" id="date" required>
                  </div>
                  <div class="form-group">
                      <label for="positionStatus">éƒ¨ä½ç‹€æ…‹ *</label>
                      <select id="positionStatus" required onchange="toggleExitFields()">
                          <option value="closed">å·²å¹³å€‰</option>
                          <option value="open">æœªå¹³å€‰(æŒå€‰ä¸­)</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="strategy">é †å‹¢/é€†å‹¢ *</label>
                      <select id="strategy" required>
                          <option value="">è«‹é¸æ“‡</option>
                          <option value="é †å‹¢">é †å‹¢</option>
                          <option value="é€†å‹¢">é€†å‹¢</option>
                      </select>
                  </div>
                  <div class="form-group" id="judgementGroup">
                      <label for="judgement">åˆ¤æ–·æ˜¯å¦æ­£ç¢º</label>
                      <select id="judgement">
                          <option value="">è«‹é¸æ“‡</option>
                          <option value="æ­£ç¢º">æ­£ç¢º</option>
                          <option value="éŒ¯èª¤">éŒ¯èª¤</option>
                      </select>
                  </div>
              </div>
              
              <div class="positions-section">
                  <div class="positions-header">
                      <h3 style="color: #667eea;">ğŸ“ˆ äº¤æ˜“éƒ¨ä½(å¯æ–°å¢å¤šæª”)</h3>
                      <button type="button" class="btn-add" onclick="addPosition()">â• æ–°å¢éƒ¨ä½</button>
                  </div>
                  <div id="positionsContainer"></div>
              </div>
              
              <div class="form-grid">
                  <div class="form-group">
                      <label for="entryReason">é€²å ´åŸå›  *</label>
                      <textarea id="entryReason" placeholder="æè¿°é€²å ´çš„æŠ€è¡“é¢ã€ç±Œç¢¼é¢æˆ–åŸºæœ¬é¢åŸå› ..." required></textarea>
                  </div>
                  <div class="form-group" id="exitReasonGroup">
                      <label for="exitReason">å‡ºå ´åŸå› </label>
                      <textarea id="exitReason" placeholder="æè¿°å‡ºå ´çš„åŸå› ..."></textarea>
                  </div>
                  <div class="form-group">
                      <label for="notes">å‚™è¨»</label>
                      <textarea id="notes" placeholder="å…¶ä»–å¿ƒå¾—æˆ–è§€å¯Ÿ..."></textarea>
                  </div>
              </div>
              
              <div class="button-group">
                  <button type="submit" class="btn-primary">â• æ–°å¢è¨˜éŒ„</button>
                  <button type="button" class="btn-info" onclick="showOpenPositionsModal()">ğŸ“‹ æœªå¹³å€‰éƒ¨ä½</button>
                  <button type="button" class="btn-success" onclick="downloadHTML()">ğŸ’¾ ä¸‹è¼‰æ—¥èªŒ</button>
                  <button type="button" class="btn-secondary" onclick="exportCSV()">ğŸ“Š åŒ¯å‡ºCSV</button>
                  <button type="button" class="btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºè¨˜éŒ„</button>
              </div>
          </form>
      </div>
      
      <div class="stats">
          <div class="stat-card">
              <h3>å·²å¹³å€‰äº¤æ˜“</h3>
              <div class="value" id="totalTrades">0</div>
          </div>
          <div class="stat-card" id="realizedPnLCard">
              <h3>å·²å¯¦ç¾æç›Š</h3>
              <div class="value" id="totalPnL">$0</div>
          </div>
          <div class="stat-card unrealized-card">
              <h3>æœªå¯¦ç¾æç›Š</h3>
              <div class="value" id="unrealizedPnL">$0</div>
          </div>
          <div class="stat-card unrealized-card">
              <h3>æœªå¹³å€‰éƒ¨ä½</h3>
              <div class="value" id="openPositionsCount">0</div>
          </div>
          <div class="stat-card">
              <h3>å‹ç‡</h3>
              <div class="value" id="winRate">0%</div>
          </div>
          <div class="stat-card">
              <h3>åˆ¤æ–·æ­£ç¢ºç‡</h3>
              <div class="value" id="correctRate">0%</div>
          </div>
      </div>
      
      <div class="settlement-section">
          <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ“… æç›Šçµç®—å ±è¡¨(åƒ…è¨ˆç®—å·²å¹³å€‰)</h2>
          <div class="settlement-controls">
              <div class="form-group" style="min-width: 150px;">
                  <label for="settlementYear">é¸æ“‡å¹´ä»½</label>
                  <select id="settlementYear" onchange="updateSettlementMonths()"></select>
              </div>
              <div class="form-group" style="min-width: 150px;">
                  <label for="settlementMonth">é¸æ“‡æœˆä»½</label>
                  <select id="settlementMonth"></select>
              </div>
              <button type="button" class="btn-info" onclick="generateDailySettlement()">ğŸ“Š æ—¥çµç®—</button>
              <button type="button" class="btn-info" onclick="generateWeeklySettlement()">ğŸ“Š é€±çµç®—</button>
              <button type="button" class="btn-info" onclick="generateMonthlySettlement()">ğŸ“Š æœˆçµç®—</button>
              <button type="button" class="btn-success" onclick="exportSettlementCSV()">ğŸ’¾ åŒ¯å‡ºå ±è¡¨</button>
          </div>
          <div id="settlementResult"></div>
      </div>
      
      <div style="overflow-x: auto;">
          <table id="tradeTable">
              <thead>
                  <tr>
                      <th>ç‹€æ…‹</th>
                      <th>æ—¥æœŸ</th>
                      <th>äº¤æ˜“éƒ¨ä½</th>
                      <th>é †/é€†å‹¢</th>
                      <th>æç›Š</th>
                      <th>é€²å ´åŸå› </th>
                      <th>å‡ºå ´åŸå› </th>
                      <th>åˆ¤æ–·</th>
                      <th>å‚™è¨»</th>
                      <th>æ“ä½œ</th>
                  </tr>
              </thead>
              <tbody id="tradeBody"></tbody>
          </table>
      </div>
  </div>
  
  <div id="closePositionModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2 style="color: #667eea;">ğŸ“¤ å¹³å€‰éƒ¨ä½</h2>
              <span class="close-modal" onclick="closeModal('closePositionModal')">&times;</span>
          </div>
          <form id="closePositionForm">
              <input type="hidden" id="closeTradeId">
              <div class="form-group">
                  <label for="closeDate">å¹³å€‰æ—¥æœŸ *</label>
                  <input type="date" id="closeDate" required>
              </div>
              <div id="closePositionsContainer"></div>
              <div class="form-group">
                  <label for="closeExitReason">å‡ºå ´åŸå›  *</label>
                  <textarea id="closeExitReason" placeholder="æè¿°å‡ºå ´çš„åŸå› ..." required></textarea>
              </div>
              <div class="form-group">
                  <label for="closeJudgement">åˆ¤æ–·æ˜¯å¦æ­£ç¢º *</label>
                  <select id="closeJudgement" required>
                      <option value="">è«‹é¸æ“‡</option>
                      <option value="æ­£ç¢º">æ­£ç¢º</option>
                      <option value="éŒ¯èª¤">éŒ¯èª¤</option>
                  </select>
              </div>
              <div class="button-group">
                  <button type="submit" class="btn-success">âœ… ç¢ºèªå¹³å€‰</button>
                  <button type="button" class="btn-secondary" onclick="closeModal('closePositionModal')">å–æ¶ˆ</button>
              </div>
          </form>
      </div>
  </div>
  
  <div id="openPositionsModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2 style="color: #ffc107;">ğŸ“‹ æœªå¹³å€‰éƒ¨ä½åˆ—è¡¨</h2>
              <span class="close-modal" onclick="closeModal('openPositionsModal')">&times;</span>
          </div>
          <div id="openPositionsList"></div>
      </div>
  </div>
  
  <div id="editPositionModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2 style="color: #17a2b8;">âœï¸ ç·¨è¼¯æœªå¹³å€‰éƒ¨ä½</h2>
              <span class="close-modal" onclick="closeModal('editPositionModal')">&times;</span>
          </div>
          <form id="editPositionForm">
              <input type="hidden" id="editTradeId">
              <div class="price-update-section">
                  <p style="margin-bottom: 15px; color: #666; font-weight: bold;">æ›´æ–°æ”¶ç›¤åƒ¹/ç¾åƒ¹:</p>
                  <div id="editPositionsContainer"></div>
                  <div id="editTotalUnrealized" class="total-unrealized">ç¸½æœªå¯¦ç¾æç›Š: $0.00</div>
              </div>
              <div class="button-group">
                  <button type="submit" class="btn-success">ğŸ’¾ å„²å­˜æ›´æ–°</button>
                  <button type="button" class="btn-secondary" onclick="closeModal('editPositionModal')">å–æ¶ˆ</button>
              </div>
          </form>
      </div>
  </div>

  <script>
let trades = JSON.parse(localStorage.getItem('trades')) || [];
let positionCounter = 0;
let currentSettlementData = null;
let currentSettlementType = null;

document.getElementById('date').valueAsDate = new Date();
addPosition();
displayTrades();
updateStats();
initializeSettlementYears();

function toggleExitFields() {
    const status = document.getElementById('positionStatus').value;
    const exitReasonGroup = document.getElementById('exitReasonGroup');
    const judgementGroup = document.getElementById('judgementGroup');
    
    if (status === 'open') {
        exitReasonGroup.style.display = 'none';
        judgementGroup.style.display = 'none';
        document.querySelectorAll('[name="exitPrice"]').forEach(el => {
            el.closest('.position-field').style.display = 'none';
            el.removeAttribute('required');
        });
        document.querySelectorAll('[name="currentPrice"]').forEach(el => {
            el.closest('.position-field').style.display = 'flex';
        });
    } else {
        exitReasonGroup.style.display = 'flex';
        judgementGroup.style.display = 'flex';
        document.querySelectorAll('[name="exitPrice"]').forEach(el => {
            el.closest('.position-field').style.display = 'flex';
            el.setAttribute('required', 'required');
        });
        document.querySelectorAll('[name="currentPrice"]').forEach(el => {
            el.closest('.position-field').style.display = 'none';
        });
    }
}

function addPosition() {
    positionCounter++;
    const container = document.getElementById('positionsContainer');
    const div = document.createElement('div');
    div.className = 'position-item';
    div.id = `position-${positionCounter}`;
    div.innerHTML = `
        <button type="button" class="remove-position-btn" onclick="removePosition(${positionCounter})">Ã—</button>
        <div class="position-field">
            <label>å•†å“é¡å‹ *</label>
            <select name="productType" required onchange="handleProductTypeChange(${positionCounter})">
                <option value="">è«‹é¸æ“‡</option>
                <option value="stock">å€‹è‚¡</option>
                <option value="futures">æœŸè²¨/æŒ‡æ•¸</option>
            </select>
        </div>
        <div class="position-field" id="symbolField-${positionCounter}">
            <label>è‚¡ç¥¨ä»£è™Ÿ/åç¨± *</label>
            <input type="text" name="symbol" placeholder="ä¾‹: 2330 å°ç©é›»" required>
        </div>
        <div class="position-field hidden" id="futuresTypeField-${positionCounter}">
            <label>æœŸè²¨é¡å‹ *</label>
            <select name="futuresType" onchange="calcPnL(${positionCounter})">
                <option value="">è«‹é¸æ“‡</option>
                <option value="å€‹è‚¡æœŸè²¨">å€‹è‚¡æœŸè²¨ (1å£=2000è‚¡)</option>
                <option value="å¾®å‹å°æŒ‡">å¾®å‹å°æŒ‡ (1é»=$10)</option>
                <option value="å°å‹å°æŒ‡">å°å‹å°æŒ‡ (1é»=$50)</option>
                <option value="å°æŒ‡æœŸ">å°æŒ‡æœŸ (1é»=$200)</option>
            </select>
        </div>
        <div class="position-field" id="instrumentField-${positionCounter}">
            <label>äº¤æ˜“å·¥å…· *</label>
            <select name="instrument" required>
                <option value="">è«‹é¸æ“‡</option>
                <option value="èè³‡">èè³‡</option>
                <option value="èåˆ¸">èåˆ¸</option>
                <option value="ç¾è‚¡">ç¾è‚¡</option>
            </select>
        </div>
        <div class="position-field">
            <label>å¤šç©ºæ–¹å‘ *</label>
            <select name="direction" required onchange="updateStyle(${positionCounter}); calcPnL(${positionCounter})">
                <option value="">è«‹é¸æ“‡</option>
                <option value="åšå¤š">åšå¤š</option>
                <option value="åšç©º">åšç©º</option>
            </select>
        </div>
        <div class="position-field">
            <label id="entryLabel-${positionCounter}">é€²å ´åƒ¹æ ¼ *</label>
            <input type="text" inputmode="decimal" name="entryPrice" placeholder="0.00" required oninput="calcPnL(${positionCounter})">
        </div>
        <div class="position-field">
            <label id="currentLabel-${positionCounter}">æ”¶ç›¤åƒ¹/ç¾åƒ¹</label>
            <input type="text" inputmode="decimal" name="currentPrice" class="current-price-field" placeholder="è¼¸å…¥ç¾åƒ¹è¨ˆç®—æç›Š" oninput="calcPnL(${positionCounter})">
        </div>
        <div class="position-field">
            <label id="exitLabel-${positionCounter}">å‡ºå ´åƒ¹æ ¼ *</label>
            <input type="text" inputmode="decimal" name="exitPrice" placeholder="0.00" required oninput="calcPnL(${positionCounter})">
        </div>
        <div class="position-field">
            <label id="quantityLabel-${positionCounter}">äº¤æ˜“å¼µæ•¸ *</label>
            <input type="text" inputmode="numeric" name="quantity" placeholder="1000" required oninput="calcPnL(${positionCounter})">
        </div>
        <div class="position-pnl" id="pnl-${positionCounter}">é ä¼°ç›ˆè™§: $0.00</div>
    `;
    container.appendChild(div);
    toggleExitFields();
}

function removePosition(id) {
    if (document.querySelectorAll('.position-item').length <= 1) {
        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹äº¤æ˜“éƒ¨ä½!');
        return;
    }
    document.getElementById(`position-${id}`)?.remove();
}

function handleProductTypeChange(id) {
    const div = document.getElementById(`position-${id}`);
    const type = div.querySelector('[name="productType"]').value;
    const symbolField = document.getElementById(`symbolField-${id}`);
    const futuresField = document.getElementById(`futuresTypeField-${id}`);
    const instrumentField = document.getElementById(`instrumentField-${id}`);
    
    if (type === 'futures') {
        symbolField.classList.add('hidden');
        futuresField.classList.remove('hidden');
        instrumentField.classList.add('hidden');
        div.querySelector('[name="symbol"]').removeAttribute('required');
        div.querySelector('[name="futuresType"]').setAttribute('required', 'required');
        div.querySelector('[name="instrument"]').removeAttribute('required');
        document.getElementById(`entryLabel-${id}`).textContent = 'é€²å ´é»ä½ *';
        document.getElementById(`currentLabel-${id}`).textContent = 'æ”¶ç›¤é»ä½/ç¾åƒ¹';
        document.getElementById(`exitLabel-${id}`).textContent = 'å‡ºå ´é»ä½ *';
        document.getElementById(`quantityLabel-${id}`).textContent = 'äº¤æ˜“å£æ•¸ *';
        div.classList.add('futures');
    } else {
        symbolField.classList.remove('hidden');
        futuresField.classList.add('hidden');
        instrumentField.classList.remove('hidden');
        div.querySelector('[name="symbol"]').setAttribute('required', 'required');
        div.querySelector('[name="futuresType"]').removeAttribute('required');
        div.querySelector('[name="instrument"]').setAttribute('required', 'required');
        document.getElementById(`entryLabel-${id}`).textContent = 'é€²å ´åƒ¹æ ¼ *';
        document.getElementById(`currentLabel-${id}`).textContent = 'æ”¶ç›¤åƒ¹/ç¾åƒ¹';
        document.getElementById(`exitLabel-${id}`).textContent = 'å‡ºå ´åƒ¹æ ¼ *';
        document.getElementById(`quantityLabel-${id}`).textContent = 'äº¤æ˜“è‚¡æ•¸ *';
        div.classList.remove('futures');
    }
    calcPnL(id);
}

function updateStyle(id) {
    const div = document.getElementById(`position-${id}`);
    const dir = div.querySelector('[name="direction"]').value;
    div.classList.remove('long', 'short');
    if (dir === 'åšå¤š') div.classList.add('long');
    else if (dir === 'åšç©º') div.classList.add('short');
}

function getPointValue(futuresType) {
    if (futuresType === 'å€‹è‚¡æœŸè²¨') return 2000;
    if (futuresType === 'å¾®å‹å°æŒ‡') return 10;
    if (futuresType === 'å°å‹å°æŒ‡') return 50;
    if (futuresType === 'å°æŒ‡æœŸ') return 200;
    return 0;
}

function calculatePnL(type, futuresType, direction, entryPrice, exitPrice, quantity) {
    let pnl = 0;
    if (type === 'futures') {
        const pv = getPointValue(futuresType);
        const diff = direction === 'åšå¤š' ? exitPrice - entryPrice : entryPrice - exitPrice;
        pnl = diff * pv * quantity;
    } else {
        // å€‹è‚¡è¨ˆç®—:åƒ¹å·® * å¼µæ•¸ * 1000è‚¡
        const diff = direction === 'åšå¤š' ? exitPrice - entryPrice : entryPrice - exitPrice;
        pnl = diff * quantity * 1000;  // â† åŠ ä¸Š * 1000
    }
    return pnl;
}


function calcPnL(id) {
    const div = document.getElementById(`position-${id}`);
    if (!div) return;
    
    const type = div.querySelector('[name="productType"]').value;
    const dir = div.querySelector('[name="direction"]').value;
    const entry = parseFloat(div.querySelector('[name="entryPrice"]').value) || 0;
    const current = parseFloat(div.querySelector('[name="currentPrice"]').value) || 0;
    const exit = parseFloat(div.querySelector('[name="exitPrice"]').value) || 0;
    const qty = parseFloat(div.querySelector('[name="quantity"]').value) || 0;
    const status = document.getElementById('positionStatus').value;
    const pnlEl = document.getElementById(`pnl-${id}`);
    const ft = div.querySelector('[name="futuresType"]')?.value || '';
    
    if (status === 'open') {
        if (current > 0 && entry > 0 && qty > 0) {
            const pnl = calculatePnL(type, ft, dir, entry, current, qty);
            pnlEl.textContent = `æœªå¯¦ç¾æç›Š: $${pnl.toLocaleString('zh-TW', {minimumFractionDigits: 2})}`;
            pnlEl.style.color = pnl >= 0 ? '#28a745' : '#dc3545';
        } else {
            pnlEl.textContent = 'æœªå¹³å€‰(æŒå€‰ä¸­)';
            pnlEl.style.color = '#ffc107';
        }
        return;
    }
    
    if (exit > 0 && entry > 0 && qty > 0) {
        const pnl = calculatePnL(type, ft, dir, entry, exit, qty);
        pnlEl.textContent = `é ä¼°ç›ˆè™§: $${pnl.toLocaleString('zh-TW', {minimumFractionDigits: 2})}`;
        pnlEl.style.color = pnl >= 0 ? '#28a745' : '#dc3545';
    }
}

document.getElementById('tradeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const status = document.getElementById('positionStatus').value;
    const positions = [];
    
    document.querySelectorAll('.position-item').forEach(div => {
        const type = div.querySelector('[name="productType"]').value;
        const dir = div.querySelector('[name="direction"]').value;
        const entry = parseFloat(div.querySelector('[name="entryPrice"]').value);
        const current = parseFloat(div.querySelector('[name="currentPrice"]').value) || null;
        const exit = status === 'closed' ? parseFloat(div.querySelector('[name="exitPrice"]').value) : null;
        const qty = parseFloat(div.querySelector('[name="quantity"]').value);
        
        let pos = {
            productType: type,
            direction: dir,
            entryPrice: entry,
            currentPrice: current,
            exitPrice: exit,
            quantity: qty
        };
        
        if (type === 'stock') {
            pos.symbol = div.querySelector('[name="symbol"]').value;
            pos.instrument = div.querySelector('[name="instrument"]').value;
        } else {
            pos.futuresType = div.querySelector('[name="futuresType"]').value;
        }
        
        if (status === 'closed') {
            pos.pnl = calculatePnL(type, pos.futuresType, dir, entry, exit, qty);
        } else if (current) {
            pos.unrealizedPnL = calculatePnL(type, pos.futuresType, dir, entry, current, qty);
        }
        
        positions.push(pos);
    });
    
    let totalUnrealized = 0;
    if (status === 'open') {
        positions.forEach(p => {
            if (p.currentPrice) {
                totalUnrealized += calculatePnL(
                    p.productType,
                    p.futuresType,
                    p.direction,
                    p.entryPrice,
                    p.currentPrice,
                    p.quantity
                );
            }
        });
    }
    
    const trade = {
        id: Date.now(),
        date: document.getElementById('date').value,
        status: status,
        strategy: document.getElementById('strategy').value,
        judgement: status === 'closed' ? document.getElementById('judgement').value : null,
        positions: positions,
        totalPnL: status === 'closed' ? positions.reduce((s, p) => s + (p.pnl || 0), 0) : 0,
        unrealizedPnL: totalUnrealized,
        entryReason: document.getElementById('entryReason').value,
        exitReason: status === 'closed' ? document.getElementById('exitReason').value : null,
        notes: document.getElementById('notes').value
    };
    
    trades.push(trade);
    localStorage.setItem('trades', JSON.stringify(trades));
    
    alert(`âœ… äº¤æ˜“è¨˜éŒ„å·²æ–°å¢!${status === 'open' && totalUnrealized !== 0 ? `\næœªå¯¦ç¾æç›Š: $${totalUnrealized.toLocaleString('zh-TW', {minimumFractionDigits: 2})}` : ''}`);
    
    this.reset();
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('positionStatus').value = 'closed';
    document.getElementById('positionsContainer').innerHTML = '';
    positionCounter = 0;
    addPosition();
    toggleExitFields();
    displayTrades();
    updateStats();
    initializeSettlementYears();
});

function displayTrades() {
    const tbody = document.getElementById('tradeBody');
    tbody.innerHTML = '';
    
    trades.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(trade => {
        const row = tbody.insertRow();
        if (trade.status === 'open') row.classList.add('open-position');
        
        const posText = trade.positions.map(p => {
            let info = '';
            if (p.productType === 'stock') {
                info = `${p.symbol} ${p.instrument} ${p.direction} ${p.quantity}è‚¡<br>é€²: $${p.entryPrice}`;
                if (p.exitPrice) info += ` â†’ å‡º: $${p.exitPrice}`;
                if (p.currentPrice && trade.status === 'open') 
                    info += `<br><span style="color:#ff9800;">ç¾åƒ¹: $${p.currentPrice}</span>`;
            } else {
                info = `${p.futuresType} ${p.direction} ${p.quantity}å£<br>é€²: ${p.entryPrice}é»`;
                if (p.exitPrice) info += ` â†’ å‡º: ${p.exitPrice}é»`;
                if (p.currentPrice && trade.status === 'open') 
                    info += `<br><span style="color:#ff9800;">ç¾åƒ¹: ${p.currentPrice}é»</span>`;
            }
            return info;
        }).join('<br><br>');
        
        const statusBadge = trade.status === 'open' 
            ? '<span class="badge badge-open">æœªå¹³å€‰</span>' 
            : '<span class="badge badge-closed">å·²å¹³å€‰</span>';
        
        let pnlDisplay = '';
        if (trade.status === 'open') {
            if (trade.unrealizedPnL !== undefined && trade.unrealizedPnL !== 0) {
                const pnlClass = trade.unrealizedPnL >= 0 ? 'profit' : 'loss';
                pnlDisplay = `<span class="unrealized">æœªå¯¦ç¾</span><br><span class="${pnlClass}">$${trade.unrealizedPnL.toLocaleString('zh-TW', {minimumFractionDigits: 2})}</span>`;
            } else {
                pnlDisplay = '<span class="unrealized">æŒå€‰ä¸­</span>';
            }
        } else {
            pnlDisplay = `<span class="${trade.totalPnL >= 0 ? 'profit' : 'loss'}">$${trade.totalPnL.toLocaleString('zh-TW', {minimumFractionDigits: 2})}</span>`;
        }
        
        const actions = trade.status === 'open' 
            ? `<button class="edit-btn" onclick="openEditModal(${trade.id})">ç·¨è¼¯</button>
               <button class="close-btn" onclick="openCloseModal(${trade.id})">å¹³å€‰</button>
               <button class="delete-btn" onclick="deleteTrade(${trade.id})">åˆªé™¤</button>`
            : `<button class="delete-btn" onclick="deleteTrade(${trade.id})">åˆªé™¤</button>`;
        
        row.innerHTML = `
            <td>${statusBadge}</td>
            <td>${trade.date}</td>
            <td style="font-size:12px;">${posText}</td>
            <td>${trade.strategy}</td>
            <td>${pnlDisplay}</td>
            <td>${trade.entryReason}</td>
            <td>${trade.exitReason || '-'}</td>
            <td class="${trade.judgement === 'æ­£ç¢º' ? 'correct' : trade.judgement === 'éŒ¯èª¤' ? 'incorrect' : ''}">${trade.judgement || '-'}</td>
            <td>${trade.notes || '-'}</td>
            <td style="white-space:nowrap;">${actions}</td>
        `;
    });
}

function updateStats() {
    const closed = trades.filter(t => t.status === 'closed');
    const open = trades.filter(t => t.status === 'open');
    
    const totalPnL = closed.reduce((s, t) => s + t.totalPnL, 0);
    const totalUnrealized = open.reduce((s, t) => s + (t.unrealizedPnL || 0), 0);
    
    const wins = closed.filter(t => t.totalPnL > 0).length;
    const correct = closed.filter(t => t.judgement === 'æ­£ç¢º').length;
    
    document.getElementById('totalTrades').textContent = closed.length;
    document.getElementById('totalPnL').textContent = `$${totalPnL.toLocaleString('zh-TW', {minimumFractionDigits: 2})}`;
    
    const realizedCard = document.getElementById('realizedPnLCard');
    realizedCard.className = 'stat-card';
    if (totalPnL > 0) realizedCard.classList.add('profit-card');
    else if (totalPnL < 0) realizedCard.classList.add('loss-card');
    
    document.getElementById('unrealizedPnL').textContent = `$${totalUnrealized.toLocaleString('zh-TW', {minimumFractionDigits: 2})}`;
    document.getElementById('openPositionsCount').textContent = open.length;
    document.getElementById('winRate').textContent = closed.length > 0 ? `${((wins / closed.length) * 100).toFixed(1)}%` : '0%';
    document.getElementById('correctRate').textContent = closed.length > 0 ? `${((correct / closed.length) * 100).toFixed(1)}%` : '0%';
}
function openEditModal(tradeId) {
    const trade = trades.find(t => t.id === tradeId);
    if (!trade) return;
    
    document.getElementById('editTradeId').value = tradeId;
    const container = document.getElementById('editPositionsContainer');
    container.innerHTML = '';
    
    trade.positions.forEach((pos, idx) => {
        const name = pos.productType === 'stock' ? pos.symbol : pos.futuresType;
        const unit = pos.productType === 'stock' ? 'å…ƒ' : 'é»';
        const currentVal = pos.currentPrice || '';
        
        const div = document.createElement('div');
        div.className = 'price-update-row';
        div.innerHTML = `
            <div>
                <label>${name}</label><br>
                <small style="color:#666;">${pos.direction} ${pos.quantity}${pos.productType === 'stock' ? 'è‚¡' : 'å£'} @ ${pos.entryPrice}${unit}</small>
            </div>
            <div>
                <label>æ”¶ç›¤åƒ¹/ç¾åƒ¹ (${unit})</label>
                <input type="text" inputmode="decimal" class="edit-current-price" data-idx="${idx}" value="${currentVal}" placeholder="è¼¸å…¥ç¾åƒ¹" oninput="calcEditUnrealized()">
            </div>
            <div class="pos-unrealized" id="edit-unrealized-${idx}" style="font-weight:bold; text-align:center;">--</div>
        `;
        container.appendChild(div);
    });
    
    calcEditUnrealized();
    document.getElementById('editPositionModal').style.display = 'block';
}

function calcEditUnrealized() {
    const tradeId = parseInt(document.getElementById('editTradeId').value);
    const trade = trades.find(t => t.id === tradeId);
    if (!trade) return;
    
    let totalUnrealized = 0;
    
    document.querySelectorAll('.edit-current-price').forEach(input => {
        const idx = parseInt(input.dataset.idx);
        const currentPrice = parseFloat(input.value) || 0;
        const pos = trade.positions[idx];
        const displayEl = document.getElementById(`edit-unrealized-${idx}`);
        
        if (currentPrice > 0) {
            const pnl = calculatePnL(
                pos.productType,
                pos.futuresType,
                pos.direction,
                pos.entryPrice,
                currentPrice,
                pos.quantity
            );
            totalUnrealized += pnl;
            displayEl.innerHTML = `<span style="color:${pnl >= 0 ? '#28a745' : '#dc3545'}">$${pnl.toLocaleString('zh-TW', {minimumFractionDigits: 2})}</span>`;
        } else {
            displayEl.innerHTML = '--';
        }
    });
    
    const totalDisplay = document.getElementById('editTotalUnrealized');
    totalDisplay.textContent = `ç¸½æœªå¯¦ç¾æç›Š: $${totalUnrealized.toLocaleString('zh-TW', {minimumFractionDigits: 2})}`;
    totalDisplay.className = 'total-unrealized';
    if (totalUnrealized > 0) totalDisplay.classList.add('profit');
    else if (totalUnrealized < 0) totalDisplay.classList.add('loss');
}

document.getElementById('editPositionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const tradeId = parseInt(document.getElementById('editTradeId').value);
    const trade = trades.find(t => t.id === tradeId);
    if (!trade) return;
    
    let totalUnrealized = 0;
    
    document.querySelectorAll('.edit-current-price').forEach(input => {
        const idx = parseInt(input.dataset.idx);
        const currentPrice = parseFloat(input.value) || null;
        trade.positions[idx].currentPrice = currentPrice;
        
        if (currentPrice) {
            const pnl = calculatePnL(
                trade.positions[idx].productType,
                trade.positions[idx].futuresType,
                trade.positions[idx].direction,
                trade.positions[idx].entryPrice,
                currentPrice,
                trade.positions[idx].quantity
            );
            totalUnrealized += pnl;
            trade.positions[idx].unrealizedPnL = pnl;
        }
    });
    
    trade.unrealizedPnL = totalUnrealized;
    localStorage.setItem('trades', JSON.stringify(trades));
    
    alert(`âœ… æœªå¹³å€‰éƒ¨ä½å·²æ›´æ–°!\næœªå¯¦ç¾æç›Š: $${totalUnrealized.toLocaleString('zh-TW', {minimumFractionDigits: 2})}`);
    
    closeModal('editPositionModal');
    displayTrades();
    updateStats();
});

function openCloseModal(tradeId) {
    const trade = trades.find(t => t.id === tradeId);
    if (!trade) return;
    
    document.getElementById('closeTradeId').value = tradeId;
    document.getElementById('closeDate').valueAsDate = new Date();
    
    const container = document.getElementById('closePositionsContainer');
    container.innerHTML = '<h3 style="margin: 15px 0; color: #667eea;">è¨­å®šå‡ºå ´åƒ¹æ ¼</h3>';
    
    trade.positions.forEach((pos, idx) => {
        const name = pos.productType === 'stock' ? pos.symbol : pos.futuresType;
        const unit = pos.productType === 'stock' ? 'å…ƒ' : 'é»';
        const defaultVal = pos.currentPrice || '';
        
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label>${name} - ${pos.direction} (é€²å ´: ${pos.entryPrice}${unit})</label>
            <input type="text" inputmode="decimal" class="close-exit-price" data-index="${idx}" placeholder="å‡ºå ´åƒ¹æ ¼/é»ä½" value="${defaultVal}" required>
            ${pos.currentPrice ? `<small style="color:#666;">æç¤º:å·²è‡ªå‹•å¸¶å…¥ç¾åƒ¹ ${pos.currentPrice}${unit}</small>` : ''}
        `;
        container.appendChild(div);
    });
    
    document.getElementById('closePositionModal').style.display = 'block';
}

function showOpenPositionsModal() {
    const open = trades.filter(t => t.status === 'open');
    const container = document.getElementById('openPositionsList');
    
    if (open.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">ç›®å‰æ²’æœ‰æœªå¹³å€‰éƒ¨ä½</p>';
    } else {
        let html = '<table style="width:100%; margin:0;"><thead><tr><th>æ—¥æœŸ</th><th>éƒ¨ä½</th><th>æœªå¯¦ç¾æç›Š</th><th>æ“ä½œ</th></tr></thead><tbody>';
        
        open.forEach(trade => {
            const posText = trade.positions.map(p => {
                let info = p.productType === 'stock' 
                    ? `${p.symbol} ${p.direction} ${p.quantity}è‚¡ @ ${p.entryPrice}` 
                    : `${p.futuresType} ${p.direction} ${p.quantity}å£ @ ${p.entryPrice}é»`;
                if (p.currentPrice) info += ` (ç¾åƒ¹: ${p.currentPrice})`;
                return info;
            }).join('<br>');
            
            let pnlDisplay = '--';
            if (trade.unrealizedPnL !== undefined && trade.unrealizedPnL !== 0) {
                const cls = trade.unrealizedPnL >= 0 ? 'profit' : 'loss';
                pnlDisplay = `<span class="${cls}">$${trade.unrealizedPnL.toLocaleString('zh-TW', {minimumFractionDigits: 2})}</span>`;
            }
            
            html += `
                <tr>
                    <td>${trade.date}</td>
                    <td style="font-size:12px;">${posText}</td>
                    <td>${pnlDisplay}</td>
                    <td style="white-space:nowrap;">
                        <button class="edit-btn" onclick="closeModal('openPositionsModal'); openEditModal(${trade.id})">ç·¨è¼¯</button>
                        <button class="close-btn" onclick="closeModal('openPositionsModal'); openCloseModal(${trade.id})">å¹³å€‰</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    document.getElementById('openPositionsModal').style.display = 'block';
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

document.getElementById('closePositionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const tradeId = parseInt(document.getElementById('closeTradeId').value);
    const trade = trades.find(t => t.id === tradeId);
    if (!trade) return;
    
    document.querySelectorAll('.close-exit-price').forEach((input, idx) => {
        trade.positions[idx].exitPrice = parseFloat(input.value);
        const pos = trade.positions[idx];
        pos.pnl = calculatePnL(
            pos.productType,
            pos.futuresType,
            pos.direction,
            pos.entryPrice,
            pos.exitPrice,
            pos.quantity
        );
    });
    
    trade.status = 'closed';
    trade.exitReason = document.getElementById('closeExitReason').value;
    trade.judgement = document.getElementById('closeJudgement').value;
    trade.totalPnL = trade.positions.reduce((s, p) => s + p.pnl, 0);
    trade.unrealizedPnL = 0;
    trade.closeDate = document.getElementById('closeDate').value;
    
    localStorage.setItem('trades', JSON.stringify(trades));
    
    alert('âœ… éƒ¨ä½å·²å¹³å€‰!');
    closeModal('closePositionModal');
    displayTrades();
    updateStats();
    initializeSettlementYears();
});

function deleteTrade(id) {
    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤äº¤æ˜“è¨˜éŒ„å—?')) {
        trades = trades.filter(t => t.id !== id);
        localStorage.setItem('trades', JSON.stringify(trades));
        displayTrades();
        updateStats();
        initializeSettlementYears();
    }
}

function clearAllData() {
    if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰äº¤æ˜“è¨˜éŒ„å—?')) {
        trades = [];
        localStorage.removeItem('trades');
        displayTrades();
        updateStats();
        initializeSettlementYears();
        alert('âœ… æ‰€æœ‰è¨˜éŒ„å·²æ¸…ç©º!');
    }
}

function downloadHTML() {
    const blob = new Blob([document.documentElement.outerHTML], {type: 'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `äº¤æ˜“æ—¥èªŒ_${new Date().toISOString().split('T')[0]}.html`;
    a.click();
}

function exportCSV() {
    let csv = '\uFEFFç‹€æ…‹,æ—¥æœŸ,å•†å“,æ–¹å‘,é€²å ´,å‡ºå ´,ç¾åƒ¹,æ•¸é‡,å·²å¯¦ç¾æç›Š,æœªå¯¦ç¾æç›Š,é †é€†å‹¢,é€²å ´åŸå› ,å‡ºå ´åŸå› ,åˆ¤æ–·,å‚™è¨»\n';
    
    trades.forEach(t => {
        t.positions.forEach((p, i) => {
            const sym = p.productType === 'stock' ? p.symbol : p.futuresType;
            const unrealizedPnL = t.status === 'open' && p.currentPrice 
                ? calculatePnL(p.productType, p.futuresType, p.direction, p.entryPrice, p.currentPrice, p.quantity) 
                : 0;
            
            csv += `${t.status === 'open' ? 'æœªå¹³å€‰' : 'å·²å¹³å€‰'},${t.date},${sym},${p.direction},${p.entryPrice},${p.exitPrice || '-'},${p.currentPrice || '-'},${p.quantity},${(p.pnl || 0).toFixed(2)},${unrealizedPnL.toFixed(2)},`;
            csv += i === 0 ? `${t.strategy},"${t.entryReason}","${t.exitReason || ''}",${t.judgement || ''},"${t.notes || ''}"\n` : ',,,,\n';
        });
    });
    
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `äº¤æ˜“è¨˜éŒ„_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

function initializeSettlementYears() {
    const closed = trades.filter(t => t.status === 'closed');
    const years = [...new Set(closed.map(t => new Date(t.date).getFullYear()))].sort((a, b) => b - a);
    if (years.length === 0) years.push(new Date().getFullYear());
    
    document.getElementById('settlementYear').innerHTML = years.map(y => `<option value="${y}">${y}å¹´</option>`).join('');
    updateSettlementMonths();
}

function updateSettlementMonths() {
    const year = parseInt(document.getElementById('settlementYear').value);
    const closed = trades.filter(t => t.status === 'closed');
    const months = [...new Set(closed.filter(t => new Date(t.date).getFullYear() === year).map(t => new Date(t.date).getMonth() + 1))].sort((a, b) => b - a);
    if (months.length === 0) months.push(new Date().getMonth() + 1);
    
    document.getElementById('settlementMonth').innerHTML = months.map(m => `<option value="${m}">${m}æœˆ</option>`).join('');
}

function isWeekday(d) {
    const day = d.getDay();
    return day !== 0 && day !== 6;
}

function getWeekNum(d) {
    return Math.ceil((d.getDate() + new Date(d.getFullYear(), d.getMonth(), 1).getDay()) / 7);
}

function generateDailySettlement() {
    const year = parseInt(document.getElementById('settlementYear').value);
    const month = parseInt(document.getElementById('settlementMonth').value);
    const closed = trades.filter(t => t.status === 'closed');
    
    const monthTrades = closed.filter(t => {
        const d = new Date(t.date);
        return d.getFullYear() === year && d.getMonth() + 1 === month;
    });
    
    const data = {};
    const days = new Date(year, month, 0).getDate();
    
    for (let i = 1; i <= days; i++) {
        const d = new Date(year, month - 1, i);
        if (isWeekday(d)) {
            const ds = d.toISOString().split('T')[0];
            data[ds] = {date: ds, trades: 0, pnl: 0, wins: 0, losses: 0};
        }
    }
    
    monthTrades.forEach(t => {
        if (data[t.date]) {
            data[t.date].trades++;
            data[t.date].pnl += t.totalPnL;
            if (t.totalPnL > 0) data[t.date].wins++;
            else if (t.totalPnL < 0) data[t.date].losses++;
        }
    });
    
    currentSettlementData = Object.values(data).sort((a, b) => a.date.localeCompare(b.date));
    currentSettlementType = 'daily';
    displaySettlement('æ—¥çµç®—', year, month);
}

function generateWeeklySettlement() {
    const year = parseInt(document.getElementById('settlementYear').value);
    const month = parseInt(document.getElementById('settlementMonth').value);
    const closed = trades.filter(t => t.status === 'closed');
    
    const monthTrades = closed.filter(t => {
        const d = new Date(t.date);
        return d.getFullYear() === year && d.getMonth() + 1 === month;
    });
    
    const data = {};
    
    monthTrades.forEach(t => {
        const wk = `ç¬¬${getWeekNum(new Date(t.date))}é€±`;
        if (!data[wk]) data[wk] = {week: wk, trades: 0, pnl: 0, wins: 0, losses: 0, days: new Set()};
        data[wk].trades++;
        data[wk].pnl += t.totalPnL;
        data[wk].days.add(t.date);
        if (t.totalPnL > 0) data[wk].wins++;
        else if (t.totalPnL < 0) data[wk].losses++;
    });
    
    currentSettlementData = Object.values(data).map(w => ({...w, tradingDays: w.days.size}));
    currentSettlementType = 'weekly';
    displaySettlement('é€±çµç®—', year, month);
}

function generateMonthlySettlement() {
    const year = parseInt(document.getElementById('settlementYear').value);
    const closed = trades.filter(t => t.status === 'closed');
    const yearTrades = closed.filter(t => new Date(t.date).getFullYear() === year);
    
    const data = {};
    for (let m = 1; m <= 12; m++) data[m] = {month: `${m}æœˆ`, trades: 0, pnl: 0, wins: 0, losses: 0, days: new Set()};
    
    yearTrades.forEach(t => {
        const m = new Date(t.date).getMonth() + 1;
        data[m].trades++;
        data[m].pnl += t.totalPnL;
        data[m].days.add(t.date);
        if (t.totalPnL > 0) data[m].wins++;
        else if (t.totalPnL < 0) data[m].losses++;
    });
    
    currentSettlementData = Object.values(data).filter(m => m.trades > 0).map(m => ({...m, tradingDays: m.days.size}));
    currentSettlementType = 'monthly';
    displaySettlement('æœˆçµç®—', year);
}

function displaySettlement(title, year, month = null) {
    const div = document.getElementById('settlementResult');
    if (!currentSettlementData || currentSettlementData.length === 0) {
        div.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">æ­¤æœŸé–“æ²’æœ‰å·²å¹³å€‰çš„äº¤æ˜“è¨˜éŒ„</p>';
        return;
    }
    
    const totalPnL = currentSettlementData.reduce((s, d) => s + d.pnl, 0);
    const totalTrades = currentSettlementData.reduce((s, d) => s + d.trades, 0);
    const totalWins = currentSettlementData.reduce((s, d) => s + d.wins, 0);
    const winRate = totalTrades > 0 ? ((totalWins / totalTrades) * 100).toFixed(1) : 0;
    
    let headers = '', rows = '';
    if (currentSettlementType === 'daily') {
        headers = '<th>æ—¥æœŸ</th><th>äº¤æ˜“æ¬¡æ•¸</th><th>ç›ˆè™§é‡‘é¡</th><th>ç²åˆ©</th><th>è™§æ</th>';
        rows = currentSettlementData.map(d => `<tr><td>${d.date}</td><td>${d.trades}</td><td class="${d.pnl >= 0 ? 'profit' : 'loss'}">$${d.pnl.toLocaleString('zh-TW', {minimumFractionDigits: 2})}</td><td>${d.wins}</td><td>${d.losses}</td></tr>`).join('');
    } else if (currentSettlementType === 'weekly') {
        headers = '<th>é€±æ¬¡</th><th>äº¤æ˜“å¤©æ•¸</th><th>äº¤æ˜“æ¬¡æ•¸</th><th>ç›ˆè™§é‡‘é¡</th><th>ç²åˆ©</th><th>è™§æ</th>';
        rows = currentSettlementData.map(d => `<tr><td>${d.week}</td><td>${d.tradingDays}</td><td>${d.trades}</td><td class="${d.pnl >= 0 ? 'profit' : 'loss'}">$${d.pnl.toLocaleString('zh-TW', {minimumFractionDigits: 2})}</td><td>${d.wins}</td><td>${d.losses}</td></tr>`).join('');
    } else {
        headers = '<th>æœˆä»½</th><th>äº¤æ˜“å¤©æ•¸</th><th>äº¤æ˜“æ¬¡æ•¸</th><th>ç›ˆè™§é‡‘é¡</th><th>ç²åˆ©</th><th>è™§æ</th>';
        rows = currentSettlementData.map(d => `<tr><td>${d.month}</td><td>${d.tradingDays}</td><td>${d.trades}</td><td class="${d.pnl >= 0 ? 'profit' : 'loss'}">$${d.pnl.toLocaleString('zh-TW', {minimumFractionDigits: 2})}</td><td>${d.wins}</td><td>${d.losses}</td></tr>`).join('');
    }
    
    const period = month ? `${year}å¹´${month}æœˆ` : `${year}å¹´`;
    div.innerHTML = `<table style="margin:0;"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>
        <div class="settlement-summary ${totalPnL < 0 ? 'negative' : ''}">
            <h3>ğŸ“Š ${period} ${title}çµ±è¨ˆ</h3>
            <div class="summary-grid">
                <div class="summary-item"><div class="label">ç¸½äº¤æ˜“æ¬¡æ•¸</div><div class="value">${totalTrades}</div></div>
                <div class="summary-item"><div class="label">ç¸½ç›ˆè™§</div><div class="value">$${totalPnL.toLocaleString('zh-TW', {minimumFractionDigits: 2})}</div></div>
                <div class="summary-item"><div class="label">å‹ç‡</div><div class="value">${winRate}%</div></div>
                <div class="summary-item"><div class="label">ç²åˆ©æ¬¡æ•¸</div><div class="value">${totalWins}</div></div>
            </div>
        </div>`;
}

function exportSettlementCSV() {
    if (!currentSettlementData || currentSettlementData.length === 0) {
        alert('âš ï¸ è«‹å…ˆç”¢ç”Ÿçµç®—å ±è¡¨');
        return;
    }
    
    const year = document.getElementById('settlementYear').value;
    const month = document.getElementById('settlementMonth').value;
    let csv = '\uFEFF', filename = '';
    
    if (currentSettlementType === 'daily') {
        csv += 'æ—¥æœŸ,äº¤æ˜“æ¬¡æ•¸,ç›ˆè™§é‡‘é¡,ç²åˆ©æ¬¡æ•¸,è™§ææ¬¡æ•¸\n';
        currentSettlementData.forEach(d => csv += `${d.date},${d.trades},${d.pnl.toFixed(2)},${d.wins},${d.losses}\n`);
        filename = `æ—¥çµç®—_${year}å¹´${month}æœˆ.csv`;
    } else if (currentSettlementType === 'weekly') {
        csv += 'é€±æ¬¡,äº¤æ˜“å¤©æ•¸,äº¤æ˜“æ¬¡æ•¸,ç›ˆè™§é‡‘é¡,ç²åˆ©æ¬¡æ•¸,è™§ææ¬¡æ•¸\n';
        currentSettlementData.forEach(d => csv += `${d.week},${d.tradingDays},${d.trades},${d.pnl.toFixed(2)},${d.wins},${d.losses}\n`);
        filename = `é€±çµç®—_${year}å¹´${month}æœˆ.csv`;
    } else {
        csv += 'æœˆä»½,äº¤æ˜“å¤©æ•¸,äº¤æ˜“æ¬¡æ•¸,ç›ˆè™§é‡‘é¡,ç²åˆ©æ¬¡æ•¸,è™§ææ¬¡æ•¸\n';
        currentSettlementData.forEach(d => csv += `${d.month},${d.tradingDays},${d.trades},${d.pnl.toFixed(2)},${d.wins},${d.losses}\n`);
        filename = `æœˆçµç®—_${year}å¹´.csv`;
    }
    
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

window.onclick = function(e) {
    if (e.target.classList.contains('modal')) e.target.style.display = 'none';
}
  </script>
</body>
</html>
